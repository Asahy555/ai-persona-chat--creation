import { NextResponse } from 'next/server';
import { generateImageWithFallback, ImageGenConfig } from '@/lib/image-generation-service';

export async function POST(request: Request) {
  try {
    const { prompt, negativePrompt, width, height, apiConfig } = await request.json();

    if (!prompt) {
      return NextResponse.json(
        { error: '–¢—Ä–µ–±—É–µ—Ç—Å—è prompt –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è' },
        { status: 400 }
      );
    }

    console.log('üé® Generating image with prompt:', prompt);

    // Use API config from request if provided
    const config: ImageGenConfig = apiConfig || {};

    // Use new image generation service with fallback
    const { imageUrl, source } = await generateImageWithFallback({
      prompt,
      negativePrompt: negativePrompt || 'low quality, blurry, distorted, deformed, ugly',
      width: width || 512,
      height: height || 512,
      steps: 20,
      cfgScale: 7,
    }, config);

    console.log(`‚úÖ Image generated by: ${source}`);

    return NextResponse.json({ 
      imageUrl,
      source // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
    return NextResponse.json(
      { error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' },
      { status: 500 }
    );
  }
}